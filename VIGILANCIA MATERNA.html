<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vigilancia Materna</title>
    <style>
        :root {
            --primary: #00796b; /* Verde Azulado M√©dico */
            --primary-dark: #004d40;
            --accent: #e91e63; /* Rosa para Puerperio */
            --emb-color: #673ab7; /* Morado para Embarazo */
            --alert-color: #d32f2f; /* Rojo Alertas */
            --bg-color: #f8f8f8;
            --card-bg: #ffffff;
            --text-main: #263238;
            --text-light: #546e7a;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Roboto', 'Segoe UI', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-main);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* --- ESTILOS DE ALERTAS (Faltaban) --- */
.alerta-card {
    background: white;
    border-left: 5px solid #d32f2f; /* Borde rojo a la izquierda */
    padding: 15px;
    margin-bottom: 10px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
    animation: fadeIn 0.3s ease;
}
.alerta-card h4 {
    margin: 0 0 5px 0;
    color: #333;
}
.alerta-card small {
    color: #666;
    font-size: 0.9em;
}

        /* --- HEADER --- */
        header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        header h1 {
            margin: 0;
            font-size: 1.4rem;
            font-weight: 500;
            letter-spacing: 0.5px;
        }

        header p {
            margin: 5px 0 0 0;
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* --- CONTENEDOR PRINCIPAL --- */
        .container {
            flex: 1;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            padding: 15px;
        }

        /* --- SECCIONES --- */
        .section { display: none; animation: fadeIn 0.3s ease-in-out; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        h2 {
            color: var(--primary-dark);
            font-size: 1.3rem;
            border-left: 5px solid var(--primary);
            padding-left: 12px;
            margin-bottom: 20px;
        }

        /* --- DASHBOARD (MEN√ö PRINCIPAL) --- */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .dash-card {
            background: var(--card-bg);
            padding: 20px 10px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 1px solid transparent;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 130px;
            position: relative;
        }

        .dash-card:active { transform: scale(0.98); }

        .dash-icon { font-size: 2.5rem; margin-bottom: 10px; display: block; }
        .dash-title { font-weight: 600; font-size: 0.95rem; color: var(--text-main); }

        /* Colores espec√≠ficos de tarjetas */
        .card-alertas { border-bottom: 4px solid var(--alert-color); }
        .card-alertas .dash-icon { color: var(--alert-color); }

        .card-registro { border-bottom: 4px solid var(--primary); }
        .card-registro .dash-icon { color: var(--primary); }

        .card-emb { border-bottom: 4px solid var(--emb-color); }
        .card-emb .dash-icon { color: var(--emb-color); }

        .card-puerp { border-bottom: 4px solid var(--accent); }
        .card-puerp .dash-icon { color: var(--accent); }

        .card-arch { border-bottom: 4px solid #607d8b; background-color: #eceff1; }
        .card-arch .dash-icon { color: #455a64; }

        /* BADGE DE ALERTAS */
        .badge-counter {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: var(--alert-color);
            color: white;
            font-size: 0.75rem;
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            display: none;
            animation: pulse 500ms infinite;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        /* ================================================= */
        /* --- 2. SUB-MEN√ö DE REGISTRO (M√ÅS CL√ÅSICO) --- */
        /* ================================================= */
        .sub-nav {
            margin-top: 30px;
            text-align: center;
            max-width: 350px;
            margin-left: auto;
            margin-right: auto;
        }
        .sub-nav button {
            background-color: #ff9800; /* Naranja Energ√©tico */
            color: white;
            padding: 15px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2em;
            font-weight: bold;
            margin: 12px 0;
            display: block;
            width: 100%;
            box-sizing: border-box;
            transition: background-color 0.3s, box-shadow 0.2s;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .sub-nav button:hover {
            background-color: #fb8c00;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        /* ================================================= */
        /* --- 3. BOTONES DE ACCI√ìN Y NAVEGACI√ìN --- */
        /* ================================================= */

        /* Bot√≥n de Guardar */
        .btn-guardar {
            background-color: #4CAF50; /* Verde Saludable */
            color: white;
            padding: 14px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 25px;
            width: 100%;
            font-weight: 600;
            transition: background-color 0.3s, box-shadow 0.2s;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .btn-guardar:hover {
            background-color: #43a047;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        /* Bot√≥n de Regreso de Formulario (Volver a seleccionar tipo) */
        .btn-regreso-form {
            background-color: #7986cb; /* Azul Suave */
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 10px;
            width: 100%;
            transition: background-color 0.3s;
        }
        .btn-regreso-form:hover {
            background-color: #5c6bc0;
        }

        /* Contenedor para la alineaci√≥n central de los botones en el detalle */
        .detalle-actions {
            margin-top: 30px;
            display: flex;
            flex-direction: column;
            gap: 10px; /* Espacio entre botones */
            align-items: center; /* Centra los botones en la pantalla de detalle */
        }

        /* Botones de detalle, ahora como bloques centrados */
        .btn-accion,
        .btn-global-regreso {
            padding: 12px 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s, transform 0.2s, box-shadow 0.3s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            width: 100%; /* Ocupa todo el ancho del contenedor 'detalle-actions' */
            max-width: 300px; /* M√°ximo ancho para que se vea bien en desktop */
            margin: 0 auto; /* Asegura el centrado en el contenedor */
            display: block;
            text-align: center;
        }

        /* Colores espec√≠ficos de los botones de Detalle */
        .btn-accion.corregir {
            background-color: #1d1402; /* Naranja/√Åmbar */
            color: white;
        }
        .btn-accion.corregir:hover {
            background-color: #ffa000;
        }
        .btn-accion.eliminar {
            background-color: #e53935; /* Rojo m√°s fuerte para eliminar permanentemente */
            color: white;
        }
        .btn-accion.eliminar:hover {
             background-color: #c62828;
             transform: translateY(-1px);
        }
        .btn-accion.archivar { /* NUEVO ESTILO DE ARCHIVAR */
            background-color: #296fa6; /* Azul */
            color: white;
        }
        .btn-accion.archivar:hover {
            background-color: #1976d2;
             transform: translateY(-1px);
        }
        .btn-detalle-regreso {
            background-color: #54609d; /* Azul suave para volver al listado */
            color: white;
        }
        .btn-detalle-regreso:hover {
            background-color: #5c6bc0;
        }
        .btn-detalle-menu {
             background-color: #158694; /* Cian para volver al men√∫ principal */
             color: white;
        }
        .btn-detalle-menu:hover {
             background-color: #0097a7;
        }

        /* Bot√≥n para a√±adir registro desde los listados (Mantiene su posici√≥n superior derecha) */
        .btn-nuevo-registro {
            background-color: #ff5722;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 20px;
            font-weight: 600;
            transition: background-color 0.3s, transform 0.2s;
            display: block;
            width: fit-content;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            float: right;
        }
        .btn-nuevo-registro:hover {
            background-color: #f4511e;
            transform: translateY(-1px);
        }

        /* Bot√≥n Global de Regreso (Usado solo en el listado-nav-top) */
        .btn-global-regreso.top-nav {
            float: left;
            color: rgb(74, 12, 10);
             background-color: #e7e435;
            margin-bottom: 20px;
            width: fit-content;
            max-width: none;
            padding: 10px 15px;
        }
        .btn-global-regreso.top-nav:hover {
            transform: translateY(-1px);
        }

        /* Contenedor de botones de navegaci√≥n dentro de listados */
        .listado-nav-top {
            overflow: auto; /* Limpia los floats (Global Regreso y Nuevo Registro) */
            margin-bottom: 10px;
        }


        /* --- 4. ESTILOS RESTANTES (Sin cambios funcionales importantes) --- */
        .form-ocultable {
            display: none !important;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        .sub-section.active {
            display: block !important;
        }

        form label {
            display: block;
            margin-top: 15px;
            font-weight: 600;
            color: #555;
        }
        input[type="text"], input[type="date"], input[type="number"], textarea { /* A√±adido textarea */
            padding: 12px;
            margin-top: 8px;
            display: block;
            width: 100%;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 6px;
        }

        /* Listado y Detalle */
        .list-container {
            display: flex;
            gap: 0;
        }

        .list-nombres {
            width: 100%;
            flex-grow: 1;
            max-height: 400px;
            overflow-y: auto;
            padding-right: 0;
            border-right: none;
            transition: all 0.3s ease;
        }

        .detalle-card {
            width: 0;
            min-width: 0;
            padding: 0;
            flex-grow: 0;
            transition: all 0.3s ease;
        }

        .list-nombres ul {
            list-style: none;
            padding: 0;
            margin-left: 0;
        }
        .list-nombres li {
            background-color: #e3f2fd; /* Azul m√°s claro */
            margin-bottom: 8px;
            padding: 12px;
            border-left: 5px solid #00bcd4;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-weight: 500;
            font-size: 1.1em;
            width: 100%;
            box-sizing: border-box;
        }
        /* Color especial para las archivadas */
        #lista-nombres-archivadas li {
             border-left: 5px solid #263238;
             background-color: #eeeeee;
        }

        .list-nombres li:hover {
            background-color: #bbdefb;
        }

        .consulta-activa .list-nombres {
            width: 0;
            min-width: 0;
            opacity: 0;
            overflow: hidden;
            flex-grow: 0;
        }
        .consulta-activa .detalle-card {
            flex-grow: 10;
            padding: 20px;
            width: auto;
            min-width: 400px;
        }

        .detalle-semanas {
            font-size: 1.6em;
            font-weight: bold;
            color: #4CAF50;
            margin-top: 10px;
            display: block;
        }
        .detalle-edad {
            font-size: 1.8em;
            font-weight: bold;
            color: #3f51b5;
            display: block;
            margin-top: 10px;
        }
        .detalle-fpp, .detalle-fin-puerperio {
            color: #d81b60; /* Usamos el color de header */
        }

        /* --- ESTILOS ESPEC√çFICOS PARA NOTAS --- */
        .nota-item {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #ddd;
            border-left: 4px solid #3f51b5;
            border-radius: 6px;
            background-color: #f9f9f9;
        }
        .nota-acciones {
            margin-top: 8px;
            text-align: right;
        }
        .nota-acciones button {
            background: none;
            border: none;
            color: #3f51b5;
            cursor: pointer;
            font-size: 0.9em;
            margin-left: 10px;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        .nota-acciones button:hover {
            background-color: #e8eaf6;
        }
        .nota-acciones button.delete {
             color: #e53935;
        }
        .nota-acciones button.delete:hover {
             background-color: #ffebee;
        }

/* --- ESTILOS MEJORADOS PARA FICHA Y PDF --- */
.ficha-container {
    background-color: #ffffff;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    overflow: hidden;
    margin-bottom: 20px;
    /* Esto asegura que los colores de fondo salgan en el PDF */
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
}

.ficha-header {
    padding: 15px 20px;
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.header-emb { background: linear-gradient(135deg, #00796b, #004d40); }
.header-puerp { background: linear-gradient(135deg, #e91e63, #880e4f); }
.header-arch { background: linear-gradient(135deg, #607d8b, #455a64); }

.ficha-header h3 { margin: 0; font-size: 1.4em; color: white !important; }
.ficha-badge {
    background: rgba(255,255,255,0.2);
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 0.85em;
    font-weight: bold;
}

.ficha-body { padding: 20px; }

/* Secci√≥n de Datos Clave (Destacado) */
.dato-destacado-box {
    background-color: #f1f8e9;
    border-left: 5px solid #4CAF50;
    padding: 15px;
    margin-bottom: 20px;
    border-radius: 4px;
}
.dato-destacado-box.alerta {
    background-color: #ffebee;
    border-left: 5px solid #d32f2f;
}
.dato-grande { font-size: 1.8em; font-weight: bold; color: #263238; display: block; }
.dato-sub { font-size: 0.95em; color: #546e7a; }

/* Grid de datos (Usamos Flex para compatibilidad PDF) */
.datos-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin-bottom: 20px;
}
.dato-item {
    flex: 1 1 45%; /* Ocupa el 45% del ancho (2 columnas) */
    min-width: 200px;
    border-bottom: 1px solid #eee;
    padding-bottom: 5px;
}
.dato-label {
    display: block;
    font-size: 0.8em;
    text-transform: uppercase;
    color: #78909c;
    font-weight: 600;
    margin-bottom: 2px;
}
.dato-valor {
    font-size: 1.1em;
    color: #37474f;
    font-weight: 500;
}

/* Tabla de Vacunas Simplificada */
.tabla-vacunas {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
    font-size: 0.9em;
}
.tabla-vacunas th { text-align: left; color: #546e7a; border-bottom: 2px solid #eee; padding: 5px; }
.tabla-vacunas td { border-bottom: 1px solid #eee; padding: 8px 5px; color: #333; }
.status-ok { color: #2e7d32; font-weight: bold; }
.status-pending { color: #c62828; font-style: italic; }

.seccion-titulo {
    color: #00796b;
    border-bottom: 2px solid #b2dfdb;
    padding-bottom: 5px;
    margin-top: 25px;
    margin-bottom: 15px;
    font-size: 1.1em;
}
        /* --- REGLAS DE RESPONSIVIDAD PARA TEL√âFONOS M√ìVILES (< 600px) --- */
        @media (max-width: 600px) {
            .container {
                max-width: 100%;
                margin: 0;
                border-radius: 0;
                box-shadow: none;
                min-height: 100vh;
            }

            header {
                padding: 15px 10px;
            }
            h1 {
                font-size: 1.5em;
            }

            .content {
                padding: 15px;
            }

            #inicio-menu button {
                padding: 15px;
                font-size: 1.2em;
                margin: 10px auto;
            }

            .list-container {
                flex-direction: column;
                gap: 20px;
            }

            .list-nombres {
                width: 100%;
                max-height: 50vh;
                flex-grow: 1;
                opacity: 1;
                min-width: auto;
                padding-right: 0;
            }

            .detalle-card {
                width: 100%;
                padding: 0;
                flex-grow: 0;
                display: none;
                min-width: auto;
            }

            .consulta-activa .list-nombres {
                width: 0;
                height: 0;
                opacity: 0;
                overflow: hidden;
                padding: 0;
                margin: 0;
                flex-grow: 0;
                display: none;
            }
            .consulta-activa .detalle-card {
                width: 100%;
                padding: 0;
                flex-grow: 1;
                min-width: auto;
                display: block;
            }

            /* Ajuste para los botones superiores en m√≥vil */
            .btn-global-regreso.top-nav, .btn-nuevo-registro {
                width: 48%;
                text-align: center;
                float: left;
                margin-right: 4%;
            }
            .btn-nuevo-registro {
                float: right;
                margin-right: 0;
            }
            /* Asegurar que los botones de detalle usen el ancho completo disponible */
             .btn-accion,
             .btn-global-regreso {
                 max-width: 100%;
             }
        }


.dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 15px;
    margin-bottom: 30px;
    margin-top: 20px;
}

.dash-card {
    background: var(--card-bg);
    padding: 20px 10px;
    border-radius: 12px;
    text-align: center;
    box-shadow: 0 8px 12px rgba(0,0,0,0.08); /* Sombra ajustada */
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    border: 1px solid #6b6565;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 130px;
    position: relative;
}

.dash-card:active { transform: scale(0.98); }
.dash-card:hover { transform: translateY(-3px); box-shadow: 0 8px 16px rgba(0,0,0,0.12); }

.dash-icon { font-size: 2.5rem; margin-bottom: 10px; display: block; }
.dash-title { font-weight: 600; font-size: 0.95rem; color: var(--text-main); }

/* Colores espec√≠ficos de tarjetas */
.card-alertas { border-bottom: 4px solid var(--alert-color); }
.card-alertas .dash-icon { color: var(--alert-color); }

.card-registro { border-bottom: 4px solid #00bcd4; }
.card-registro .dash-icon { color: #00bcd4; }

.card-emb { border-bottom: 4px solid var(--emb-color); }
.card-emb .dash-icon { color: var(--emb-color); }

.card-puerp { border-bottom: 4px solid var(--accent); }
.card-puerp .dash-icon { color: var(--accent); }

.card-arch { border-bottom: 4px solid #607d8b; background-color: #eceff1; }
.card-arch .dash-icon { color: #455a64; }

/* Badge (Contador) de Alertas */
.badge-counter {
    position: absolute;
    top: 10px;
    right: 10px;
    background-color: var(--alert-color);
    color: white;
    font-size: 0.97rem;
    font-weight: bold;
    padding: 12px 18px;
    border-radius: 18px;
    box-shadow: 0 5px 4px rgba(0,0,0,0.2);
    display: none; /* Se activa con JS */
}

/* Acciones de Respaldo (Botones peque√±os abajo) */
.backup-actions {
    background: white;
    padding: 15px;
    border-radius: 20px;
    display: flex;
    gap: 10px;
    justify-content: center;
    box-shadow: 0 13px 8px rgba(0,0,0,0.05);
}
.btn-backup {
    flex: 1;
    padding: 10px;
    border: 1px solid #080808;
    background: white;
    border-radius: 10px;
    font-size: 0.85rem;
    color: #081921;
    cursor: pointer;
    font-weight: 600;
}
.btn-backup:hover { background: #f5f5f5; }

 /* --- FOOTER (COPYRIGHT) --- */
        footer {
            background-color: #263238;
            color: #90a4ae;
            text-align: center;
            padding: 15px;
            font-size: 0.8rem;
            margin-top: auto; /* Empuja el footer al fondo */
        }

        /* Utilidades */
        .nav-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .back-btn { background: none; border: none; font-size: 1.2rem; cursor: pointer; color: var(--text-light); padding: 5px; }
        .hidden { display: none !important; }

        /* --- ANIMACI√ìN BOT√ìN DE ALERTA --- */
@keyframes latido-alerta {
    0% {
        box-shadow: 0 0 0 0 rgba(211, 47, 47, 0.7);
        transform: scale(1);
    }
    50% {
        transform: scale(1.05); /* Se agranda un poquito */
    }
    70% {
        box-shadow: 0 0 0 10px rgba(211, 47, 47, 0); /* El halo se desvanece */
    }
    100% {
        box-shadow: 0 0 0 0 rgba(211, 47, 47, 0);
        transform: scale(1);
    }
}

.btn-alerta-blink {
    background-color: #d32f2f; /* Rojo fuerte */
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 20px; /* Bordes redondos */
    cursor: pointer;
    font-weight: bold;
    font-size: 0.9em;
    /* Aqu√≠ aplicamos la animaci√≥n infinita */
    animation: latido-alerta 1.5s infinite;
    transition: background-color 0.3s;
}

.btn-alerta-blink:hover {
    background-color: #b71c1c; /* Rojo m√°s oscuro al tocar */
    animation: none; /* Detener parpadeo al poner el dedo encima */
}

/* --- NUEVO ESTILO: PANEL DE CONTROL FUTURISTA --- */
.control-panel {
    background: #ffffff;
    border-radius: 20px;
    padding: 20px;
    margin-top: 25px;
    box-shadow: 0 10px 30px -10px rgba(0,0,0,0.15);
    border: 1px solid rgba(0,0,0,0.05);
}
.control-header {
    font-size: 0.85em; text-transform: uppercase; color: #90a4ae;
    letter-spacing: 1px; margin-bottom: 15px; text-align: center; font-weight: bold;
}
.btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

/* Botones Pro */
.btn-pro {
    border: none; border-radius: 12px; padding: 12px 10px;
    font-size: 0.95em; font-weight: 600; cursor: pointer; color: white;
    display: flex; align-items: center; justify-content: center; gap: 8px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: transform 0.2s;
}
.btn-pro:active { transform: scale(0.96); }
.full-width { grid-column: span 2; }

/* Colores */
.pro-birth { background: linear-gradient(135deg, #e91e63, #c2185b); box-shadow: 0 4px 15px rgba(233, 30, 99, 0.4); margin-bottom: 10px; font-size: 1.1em; }
.pro-pdf { background: linear-gradient(135deg, #2196F3, #1976D2); }
.pro-edit { background: linear-gradient(135deg, #00BCD4, #0097A7); }
.pro-archive { background: linear-gradient(135deg, #7E57C2, #512DA8); }
.pro-delete { background: rgb(43, 35, 35); color: #e53935; border: 2px solid #ffcdd2; }
.pro-back { grid-column: span 2; background: #f5f5f5; color: #546e7a; margin-top: 5px; }

/* --- ESTILOS PARA LA VENTANA DE CONFIRMACI√ìN DE PARTO --- */
.modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.6); /* Fondo oscuro transparente */
    display: none; /* Oculto por defecto */
    justify-content: center; align-items: center; z-index: 2000;
}
.modal-content {
    background: white; padding: 25px; border-radius: 15px; width: 90%; max-width: 350px;
    text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.3);
    animation: fadeIn 0.2s ease-out;
}
.modal-titulo { color: #e91e63; margin-top: 0; font-size: 1.4em; }
.btn-modal-cancel { background: #cfd8dc; color: #455a64; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: bold;}
.btn-modal-confirm { background: #e91e63; color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 10px rgba(233,30,99,0.3); }
    </style>
	
	<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#00796b">
<link rel="apple-touch-icon" href="icon-192.png">

<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js')
        .then(registration => {
          console.log('ServiceWorker registrado con √©xito:', registration.scope);
        })
        .catch(err => {
          console.log('Fallo al registrar ServiceWorker:', err);
        });
    });
  }
</script>
</head>
<body>

<header>
    <h1>üë©‚Äç‚öïÔ∏è Vigilancia Materna</h1>
    <p>Salud Comunitaria Coatepeque</p>
</header>

<div class="container">

    <!-- SECCI√ìN: INICIO (DASHBOARD) -->
    <div id="inicio" class="section active">

        <!-- Grid de Tarjetas -->
        <div class="dashboard-grid">
            <!-- Alertas -->
            <div class="dash-card card-alertas" onclick="mostrarSeccion('panel-alertas')">
                <span id="contador-alertas" class="badge-counter" style="display:block;">0</span>
                <span class="dash-icon">üîî</span>
                <span class="dash-title">Alertas</span>
            </div>

            <!-- Registrar -->
            <div class="dash-card card-registro" onclick="mostrarSeccion('registro')">
                <span class="dash-icon">‚ûï</span>
                <span class="dash-title">Registrar</span>
            </div>

            <!-- Embarazadas -->
            <div class="dash-card card-emb" onclick="mostrarSeccion('listado-embarazadas')">
                <span class="dash-icon">ü§∞</span>
                <span class="dash-title">Embarazadas</span>
            </div>

            <!-- Pu√©rperas -->
            <div class="dash-card card-puerp" onclick="mostrarSeccion('listado-puerperas')">
                <span class="dash-icon">ü§±</span>
                <span class="dash-title">Pu√©rperas</span>
            </div>

            <!-- Archivadas -->
            <div class="dash-card card-arch" onclick="mostrarSeccion('listado-archivadas')">
                <span class="dash-icon">üì¶</span>
                <span class="dash-title">Archivadas</span>
            </div>
        </div>

        <!-- Acciones de Respaldo -->
        <div class="backup-actions">
            <button class="btn-backup" onclick="exportarDatos()">üíæ Guardar Copia</button>
            <button class="btn-backup" onclick="document.getElementById('file-input-backup').click()">üì• Restaurar</button>
            <input type="file" id="file-input-backup" accept=".json" style="display: none;" onchange="importarDatos(event)">
        </div>
		<div style="margin: 20px; padding: 15px; background: #fff; border: 1px solid #ccc; border-radius: 8px; text-align: center;">
    <h4 style="margin-top:0;">Base de Datos (Google Sheets)</h4>
    <button id="btn-nube-guardar" onclick="guardarEnNube()" style="background: #4CAF50; color: white; padding: 10px; border: none; border-radius: 5px; margin: 5px; width: 45%;">
        ‚òÅÔ∏è Guardar en Nube
    </button>
    <button id="btn-nube-cargar" onclick="cargarDeNube()" style="background: #2196F3; color: white; padding: 10px; border: none; border-radius: 5px; margin: 5px; width: 45%;">
        üì• Bajar de Nube
    </button>
</div>
    </div>
	


    <div id="panel-alertas" class="section">
        <div class="listado-nav-top">
            <button class="btn-global-regreso top-nav" onclick="mostrarSeccion('inicio')">‚Üê Volver al Men√∫</button>
        </div>
        <h2 style="color: #d32f2f; border-color: #d32f2f;">‚ö†Ô∏è Alertas del D√≠a</h2>

        <div id="contenedor-alertas" style="padding: 10px;">
        </div>
    </div>
	

    <div id="registro" class="section">
        <button class="btn-global-regreso top-nav" onclick="mostrarSeccion('inicio')">‚Üê Volver al Men√∫ Principal</button>
        <h2>‚ûï Registrar Nueva Paciente</h2>

        <div class="sub-nav" id="menu-registro-tipo">
            <button id="btn-reg-emb" onclick="mostrarRegistroSub('form-embarazada')">Registrar Embarazada</button>
            <button id="btn-reg-puerp" onclick="mostrarRegistroSub('form-puerpera')">Registrar Pu√©rpera</button>
        </div>

        <div id="form-embarazada" class="sub-section form-ocultable">
            <form id="registro-form-embarazada">
                <label for="nombre-emb">Nombre de la Paciente:</label>
                <input type="text" id="nombre-emb" required placeholder="Ej: Juana P√©rez">
                <label for="fn-emb">Fecha de Nacimiento (FN) (Opcional):</label>
                <input type="date" id="fn-emb">

                <label style="margin-top: 25px; font-weight: 600; color: #555;">Fuente de C√°lculo (Requerido):</label>
                <div style="display: flex; gap: 20px; margin-top: 10px; margin-bottom: 10px;">
                    <label><input type="radio" name="metodo_calc" value="FUR" checked onchange="toggleFurFusFields('FUR')"> Fecha √öltima Regla (FUR)</label>
                    <label><input type="radio" name="metodo_calc" value="FUS" onchange="toggleFurFusFields('FUS')"> Ultrasonido (FUS)</label>
                </div>

                <div id="fields-fur">
                    <label for="fur">Fecha de √öltima Regla (FUR):</label>
                    <input type="date" id="fur" required>
                </div>

                <div id="fields-fus" style="display: none;">
                    <label for="fus_date">Fecha de Ultrasonido (FUS):</label>
                    <input type="date" id="fus_date">
                    <label for="egus_weeks">Semanas de Gestaci√≥n por US:</label>
                    <input type="number" id="egus_weeks" min="1" max="45" value="12">
                    <label for="egus_days">D√≠as de Gestaci√≥n por US (0-6):</label>
                    <input type="number" id="egus_days" min="0" max="6" value="0">
                </div>

                <hr>

                <h3>üíâ Vacunas (Fecha de Aplicaci√≥n)</h3>
                <label for="vacuna-influenza">Influenza:</label>
                <input type="date" id="vacuna-influenza">

                <label for="vacuna-dtpa">DTPa:</label>
                <input type="date" id="vacuna-dtpa">

                <label for="vacuna-dtadulto">DT Adulto:</label>
                <input type="date" id="vacuna-dtadulto">

                <label for="vacuna-vrs">VRS:</label>
                <input type="date" id="vacuna-vrs">
                <button type="submit" class="btn-guardar">Guardar Embarazada</button>
                <button type="button" onclick="regresarAMenuRegistro()" class="btn-regreso-form">‚Üê Volver a Seleccionar Tipo</button>
            </form>
        </div>

        <div id="form-puerpera" class="sub-section form-ocultable">
            <form id="registro-form-puerpera">
                <label for="nombre-puerp">Nombre de la Paciente:</label>
                <input type="text" id="nombre-puerp" required placeholder="Ej: Ana G√≥mez">
                <label for="fn-puerp">Fecha de Nacimiento (FN) (Opcional):</label>
                <input type="date" id="fn-puerp">
                <label for="fp">Fecha de Parto (FP):</label>
                <input type="date" id="fp" required>
                <button type="submit" class="btn-guardar">Guardar Pu√©rpera</button>
                <button type="button" onclick="regresarAMenuRegistro()" class="btn-regreso-form">‚Üê Volver a Seleccionar Tipo</button>
            </form>
        </div>
    </div>

    <div id="listado-embarazadas" class="section">

        <div class="listado-nav-top">
            <button class="btn-global-regreso top-nav" onclick="mostrarSeccion('inicio')">‚Üê Men√∫ Principal</button>
            <button class="btn-nuevo-registro" onclick="iniciarRegistroDirecto('embarazada')">‚ûï Nuevo Registro</button>
        </div>

        <h2>ü§∞ Listado de Embarazadas</h2>
        <div class="list-container" id="list-container-emb">
            <div class="list-nombres">
                <ul id="lista-nombres-embarazadas"></ul>
            </div>
            <div id="detalle-embarazada" class="detalle-card">
            </div>
        </div>
    </div>

    <div id="listado-puerperas" class="section">

        <div class="listado-nav-top">
            <button class="btn-global-regreso top-nav" onclick="mostrarSeccion('inicio')">‚Üê Men√∫ Principal</button>
            <button class="btn-nuevo-registro" onclick="iniciarRegistroDirecto('puerpera')">‚ûï Nuevo Registro</button>
        </div>

        <h2>ü§± Listado de Pu√©rperas</h2>
        <div class="list-container" id="list-container-puerp">
            <div class="list-nombres">
                <ul id="lista-nombres-puerperas"></ul>
            </div>
            <div id="detalle-puerpera" class="detalle-card">
            </div>
        </div>
    </div>

    <div id="listado-archivadas" class="section">

        <div class="listado-nav-top">
            <button class="btn-global-regreso top-nav" onclick="mostrarSeccion('inicio')">‚Üê Men√∫ Principal</button>
        </div>

        <h2>üì¶ Listado de Pacientes Archivadas</h2>
        <div class="list-container" id="list-container-arch">
            <div class="list-nombres">
                <ul id="lista-nombres-archivadas"></ul>
            </div>
            <div id="detalle-archivada" class="detalle-card">
            </div>
        </div>
    </div>
</div>


<div id="modal-parto" class="modal-overlay">
    <div class="modal-content">
        <h3 class="modal-titulo">üë∂ Registrar Nacimiento</h3>
        <p>Confirma la fecha exacta del parto para <strong id="nombre-paciente-parto"></strong>:</p>

        <label style="display:block; text-align:left; font-size:0.9em; margin-bottom:5px; color:#555;">Seleccionar Fecha:</label>
        <input type="date" id="fecha-parto-calendario" style="font-size: 1.2em; margin-bottom: 20px;">

        <div style="display:flex; justify-content: space-between;">
            <button class="btn-modal-cancel" onclick="cancelarParto()">Cancelar</button>
            <button class="btn-modal-confirm" onclick="confirmarParto()">‚úÖ Confirmar</button>
        </div>
    </div>
</div>


<!-- FOOTER CON COPYRIGHT -->
<footer>
    ¬© Mois√©s Abimael Labor - Vigilancia Materna v2.0
</footer>


<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<script>
    // --- VARIABLES DE DATOS ---
    let embarazadas = JSON.parse(localStorage.getItem('embarazadas')) || [];
    let puerperas = JSON.parse(localStorage.getItem('puerperas')) || [];
    // NUEVA LISTA DE PACIENTES ARCHIVADAS
    let archivadas = JSON.parse(localStorage.getItem('archivadas')) || [];

    const detalleEmbDiv = document.getElementById('detalle-embarazada');
    const detallePuerpDiv = document.getElementById('detalle-puerpera');
    const detalleArchDiv = document.getElementById('detalle-archivada'); // Nuevo
    const menuRegistroTipo = document.getElementById('menu-registro-tipo');
    const listContainerEmb = document.getElementById('list-container-emb');
    const listContainerPuerp = document.getElementById('list-container-puerp');
    const listContainerArch = document.getElementById('list-container-arch'); // Nuevo

    // --- FUNCIONES DE UTILIDAD Y C√ÅLCULO ---

    function getHoyLocal() {
        const now = new Date();
        return new Date(now.getFullYear(), now.getMonth(), now.getDate());
    }

// Funci√≥n para obtener la fecha de HOY en formato YYYY-MM-DD respetando tu zona horaria
function obtenerFechaLocalISO() {
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

    function crearFechaLocal(dateString) {
        const parts = dateString.split('-');
        // Asume formato 'YYYY-MM-DD'
        return new Date(parts[0], parts[1] - 1, parts[2]);
    }

    function calcularEdad(fechaNacimientoDate) {
        const hoy = new Date();
        let edad = hoy.getFullYear() - fechaNacimientoDate.getFullYear();
        const mes = hoy.getMonth() - fechaNacimientoDate.getMonth();

        if (mes < 0 || (mes === 0 && hoy.getDate() < fechaNacimientoDate.getDate())) {
            edad--;
        }
        return edad;
    }

    function calcularFPP(furDate) {
        const fpp = new Date(furDate);
        fpp.setDate(fpp.getDate() + 280);
        return fpp;
    }

    function calcularFinPuerperio(fpDate) {
        const finPuerperio = new Date(fpDate);
        finPuerperio.setDate(finPuerperio.getDate() + 42);
        return finPuerperio;
    }

    function calcularEdadGestacional(furDate) {
        const hoy = getHoyLocal();
        const diasTranscurridos = Math.floor((hoy.getTime() - furDate.getTime()) / (1000 * 60 * 60 * 24));

        if (diasTranscurridos < 0) return { semanas: 0, dias: 0, diasRestantes: 280, diasTranscurridos: 0 };

        const semanas = Math.floor(diasTranscurridos / 7);
        const dias = diasTranscurridos % 7;
        const diasRestantes = 280 - diasTranscurridos;

        return { semanas, dias, diasRestantes, diasTranscurridos };
    }

        // --- NUEVA FUNCI√ìN: Calcular semanas exactas al momento del parto ---
    function calcularEdadGestacionalAlParto(furDate, fpDate) {
        // Diferencia en milisegundos
        const diffTime = fpDate.getTime() - furDate.getTime();
        // Convertir a d√≠as
        const diasTotales = Math.floor(diffTime / (1000 * 60 * 60 * 24));

        if (diasTotales < 0) return "Error en fechas";

        const semanas = Math.floor(diasTotales / 7);
        const dias = diasTotales % 7;

        return `${semanas} Semanas + ${dias} d√≠as`;
    }


    function calcularPuerperio(fpDate) {
        const hoy = getHoyLocal();
        const diasPuerperio = Math.floor((hoy.getTime() - fpDate.getTime()) / (1000 * 60 * 60 * 24));

        const finPuerperioDate = calcularFinPuerperio(fpDate);
        const diasRestantes = 42 - diasPuerperio;

        return { diasPuerperio, diasRestantes, finPuerperioDate };
    }

    function calcularFechaSeguimiento(fpDate, dias) {
        const fecha = new Date(fpDate);
        fecha.setDate(fecha.getDate() + dias);
        return fecha;
    }

    function calcularFechasSeguimientoPuerpera(fpDate) {
        return {
            '24 horas': calcularFechaSeguimiento(fpDate, 1),
            '3 d√≠as': calcularFechaSeguimiento(fpDate, 3),
            '7 d√≠as': calcularFechaSeguimiento(fpDate, 7),
            '15 d√≠as': calcularFechaSeguimiento(fpDate, 15),
            '28 d√≠as': calcularFechaSeguimiento(fpDate, 28)
        };
    }

    function formatDate(date) {
        const options = { day: '2-digit', month: '2-digit', year: 'numeric' };
        return new Intl.DateTimeFormat('es-ES', options).format(date);
    }

    // FUNCI√ìN DE GUARDADO MODIFICADA PARA ARCHIVADAS
    function guardarDatos(tipo) {
         if (tipo === 'embarazadas') {
            localStorage.setItem(tipo, JSON.stringify(embarazadas));
        } else if (tipo === 'puerperas') {
            localStorage.setItem(tipo, JSON.stringify(puerperas));
        } else if (tipo === 'archivadas') {
            localStorage.setItem(tipo, JSON.stringify(archivadas));
        }
    }

   // --- JAVASCRIPT ---

function exportarDatos() {
    // 1. Recopilar datos globales
    const data = {
        fecha_backup: new Date().toISOString(),
        embarazadas: typeof embarazadas !== 'undefined' ? embarazadas : [],
        puerperas: typeof puerperas !== 'undefined' ? puerperas : [],
        archivadas: typeof archivadas !== 'undefined' ? archivadas : []
    };

    const dataStr = JSON.stringify(data, null, 4);

    // 2. Detectar entorno
    if (typeof Android !== "undefined" && Android.guardarBackup) {
        // Opci√≥n A: Estamos en la App M√≥vil
        Android.guardarBackup(dataStr);
    } else {
        // Opci√≥n B: Estamos en PC / Navegador Web -> Forzar descarga
        descargarEnPC(dataStr, "backup_materno.json");
    }
}

// Funci√≥n auxiliar para descargar en PC
function descargarEnPC(content, fileName) {
    const a = document.createElement("a");
    const file = new Blob([content], { type: "application/json" });
    a.href = URL.createObjectURL(file);
    a.download = fileName;
    a.click();
    URL.revokeObjectURL(a.href);
}

function importarDatos(event) {
    const file = event.target.files[0];

    if (!file) return;

    if (!file.name.endsWith('.json')) {
        alert('‚ö†Ô∏è Error: Por favor, selecciona un archivo .json.');
        event.target.value = null;
        return;
    }

    const reader = new FileReader();

    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);

            // Validaci√≥n b√°sica de estructura
            if (!data.embarazadas || !data.puerperas || !data.archivadas) {
                alert('üö´ El archivo no tiene el formato correcto de la App.');
                return;
            }

            const total = data.embarazadas.length + data.puerperas.length + data.archivadas.length;
            const fecha = data.fecha_backup ? new Date(data.fecha_backup).toLocaleDateString() : 'Desconocida';

            if (confirm(`‚ö†Ô∏è ¬øReemplazar datos actuales con el respaldo del ${fecha} (${total} registros)?`)) {
                
                // Actualizar variables globales
                embarazadas = data.embarazadas;
                puerperas = data.puerperas;
                archivadas = data.archivadas;

                // Guardar en localStorage (Asumiendo que esta funci√≥n existe en tu c√≥digo)
                guardarDatos('embarazadas');
                guardarDatos('puerperas');
                guardarDatos('archivadas');

                alert('‚úÖ Datos restaurados correctamente.');
                
                // Recargar vista (Asumiendo que esta funci√≥n existe)
                if(typeof mostrarSeccion === 'function') mostrarSeccion('inicio');
                else location.reload(); 
            }
        } catch (error) {
            console.error(error);
            alert('üö´ Archivo corrupto o ilegible.');
        } finally {
            event.target.value = null; // Limpiar el input para permitir re-selecci√≥n
        }
    };
    reader.readAsText(file);
}
    // --- PEGAR ALREDEDOR DE LA L√çNEA 764 ---

    // --- FUNCION CORREGIDA PARA QUE SALGAN TODAS LAS NOTAS ---
function descargarPDF(index, tipo) {
    const data = getPacientePorIndex(index, tipo);
    const paciente = data.paciente;

    // Identificar el elemento a imprimir
    let elementId = '';
    if (tipo === 'embarazada') elementId = `vista-info-emb-${index}`;
    else if (tipo === 'puerpera') elementId = `vista-info-puerp-${index}`;
    else if (tipo === 'archivada') elementId = `vista-info-arch-${index}`;

    const element = document.getElementById(elementId);
    if (!element) { alert("Error: No se encuentra la vista."); return; }

    // 1. Configuraci√≥n
    const nombreArchivo = `Ficha_${tipo}_${paciente.nombre.replace(/ /g, '_')}.pdf`;
    const opt = {
        margin:       [0.5, 0.5, 0.5, 0.5],
        filename:     nombreArchivo,
        image:        { type: 'jpeg', quality: 0.98 },
        html2canvas:  { scale: 2, useCORS: true, scrollY: 0 },
        jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' },
        pagebreak:    { mode: ['avoid-all', 'css', 'legacy'] }
    };

    // 2. Clonar y limpiar
    const clone = element.cloneNode(true);
    const elementosNoDeseados = clone.querySelectorAll('button, .detalle-actions, form, textarea');
    elementosNoDeseados.forEach(el => el.remove());

    // --- CORRECCI√ìN AQU√ç: BUSCAR TODAS LAS LISTAS (ul) Y EXPANDIRLAS ---
    // Antes us√°bamos querySelector (solo una), ahora usamos querySelectorAll (todas)
    const listasNotas = clone.querySelectorAll('ul');
    listasNotas.forEach(lista => {
        lista.style.maxHeight = 'none';
        lista.style.overflow = 'visible';
    });
    // -------------------------------------------------------------------

    // Header
    const header = document.createElement('div');
    header.innerHTML = `
        <div style="text-align: center; margin-bottom: 20px; border-bottom: 2px solid #00796b; padding-bottom: 10px;">
            <h2 style="color:#00796b; margin: 0;">Ficha Cl√≠nica - Vigilancia Materna</h2>
            <p style="color:#555; margin: 5px 0 0 0;">Salud Comunitaria Coatepeque</p>
            <p style="font-size: 0.8em; color: #888;">Estado: ${tipo.toUpperCase()} | Fecha: ${new Date().toLocaleDateString()}</p>
        </div>
    `;
    clone.insertBefore(header, clone.firstChild);

    // Contenedor temporal oculto
    const contenedorTemporal = document.createElement('div');
    contenedorTemporal.style.position = 'absolute';
    contenedorTemporal.style.left = '-9999px';
    contenedorTemporal.style.top = '0';
    contenedorTemporal.style.width = '800px';
    contenedorTemporal.style.backgroundColor = 'white';
    contenedorTemporal.style.padding = '20px';
    contenedorTemporal.appendChild(clone);
    document.body.appendChild(contenedorTemporal);

    // Generar PDF
    html2pdf().set(opt).from(clone).toPdf().output('datauristring').then(function (pdfAsString) {
        const base64 = pdfAsString.split(',')[1];

        if (typeof Android !== "undefined" && Android.guardarPDF) {
            Android.guardarPDF(base64, nombreArchivo);
        } else {
            html2pdf().set(opt).from(clone).save();
        }
        document.body.removeChild(contenedorTemporal);
    }).catch(err => {
        console.error(err);
        document.body.removeChild(contenedorTemporal);
        alert("‚ùå Error al generar el PDF.");
    });
}
    // --- FUNCIONES DE UTILIDAD para FUS ---

    function toggleFurFusFields(metodo) {
        const furFields = document.getElementById('fields-fur');
        const fusFields = document.getElementById('fields-fus');
        const furInput = document.getElementById('fur');
        const fusDateInput = document.getElementById('fus_date');

        if (metodo === 'FUR') {
            furFields.style.display = 'block';
            fusFields.style.display = 'none';
            furInput.required = true;
            fusDateInput.required = false;
        } else { // FUS
            furFields.style.display = 'none';
            fusFields.style.display = 'block';
            furInput.required = false;
            fusDateInput.required = true;
        }
    }

    function calcularFURDesdeUS(fusDate, semanas, dias) {
        const egDias = (semanas * 7) + dias;
        const fur = new Date(fusDate);
        fur.setDate(fur.getDate() - egDias);

        const year = fur.getFullYear();
        const month = String(fur.getMonth() + 1).padStart(2, '0');
        const day = String(fur.getDate()).padStart(2, '0');

        return `${year}-${month}-${day}`;
    }

    function getEffectiveFURDate(embarazada) {
        return crearFechaLocal(embarazada.fur);
    }

    const getVacunaStatus = (vacunaDate) => {
        if (!vacunaDate || vacunaDate === '') return 'Pendiente ‚ùå';
        return `Aplicada (${formatDate(crearFechaLocal(vacunaDate))}) ‚úÖ`;
    };

    // --- FUNCIONES PARA NOTAS IMPORTANTES (MODIFICADAS) ---

    // Encuentra el paciente por index y tipo (incluyendo archivadas)
    function getPacientePorIndex(index, tipo) {
        if (tipo === 'embarazada') return { lista: embarazadas, clave: 'embarazadas', paciente: embarazadas[index] };
        if (tipo === 'puerpera') return { lista: puerperas, clave: 'puerperas', paciente: puerperas[index] };
        if (tipo === 'archivada') return { lista: archivadas, clave: 'archivadas', paciente: archivadas[index] };
        return null;
    }

   function renderizarNotas(paciente, pacienteIndex, tipo) {
        if (!paciente.notas || paciente.notas.length === 0) {
            return '<p>No hay notas registradas para esta paciente.</p>';
        }

        let html = '<ul style="list-style: none; padding-left: 0; max-height: 250px; overflow-y: auto; padding-right: 15px;">';

        paciente.notas.forEach((nota, notaIndex) => {
            const isArchived = tipo === 'archivada';
            const notaId = `nota-item-${tipo}-${pacienteIndex}-${notaIndex}`;

            // --- L√ìGICA DE ETIQUETA VISUAL ---
            let etiquetaHtml = '';
            // Solo mostramos la etiqueta si estamos en Puerpera o Archivada, y si la nota tiene etapa
            if ((tipo === 'puerpera' || tipo === 'archivada') && nota.etapa) {
                let colorFondo = '#9e9e9e'; // Gris por defecto
                if (nota.etapa === 'Embarazo') colorFondo = '#673ab7'; // Morado
                else if (nota.etapa === 'Puerperio') colorFondo = '#e91e63'; // Rosa
                else if (nota.etapa === 'Sistema') colorFondo = '#2196f3'; // Azul

                etiquetaHtml = `<span style="background-color: ${colorFondo}; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.75em; margin-left: 8px; vertical-align: text-bottom; font-weight: normal;">${nota.etapa}</span>`;
            }

            html += `
                <li id="${notaId}" class="nota-item">
                    <p style="margin: 0 0 5px 0; font-weight: 600; color: #3f51b5;">
                        ${nota.fecha} ${etiquetaHtml}
                    </p>
                    <p class="nota-texto" style="margin: 0; white-space: pre-wrap;">${nota.texto}</p>
                    ${!isArchived ? `
                        <div class="nota-acciones">
                            <button onclick="iniciarEdicionNota(${pacienteIndex}, ${notaIndex}, '${tipo}')">‚úèÔ∏è Editar</button>
                            <button class="delete" onclick="eliminarNota(${pacienteIndex}, ${notaIndex}, '${tipo}')">üóëÔ∏è Eliminar</button>
                        </div>
                    ` : ''}
                </li>
            `;
        });

        html += '</ul>';
        return html;
    }

   function a√±adirNota(index, tipo) {
        const notaTextoId = `nueva-nota-${tipo}`;
        const notaTexto = document.getElementById(notaTextoId).value.trim();

        if (notaTexto === '') {
            alert('Por favor, ingresa el texto de la nota.');
            return;
        }

        const now = new Date();
        const fechaHora = now.toLocaleString('es-ES', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });

        // --- CAMBIO: DETERMINAR ETAPA ---
        let etapaLabel = 'General';
        if (tipo === 'embarazada') etapaLabel = 'Embarazo';
        else if (tipo === 'puerpera') etapaLabel = 'Puerperio';
        else if (tipo === 'archivada') etapaLabel = 'Archivo';

        const nuevaNota = {
            fecha: fechaHora,
            texto: notaTexto,
            etapa: etapaLabel // <--- Guardamos la etapa aqu√≠
        };

        const data = getPacientePorIndex(index, tipo);
        if (!data) return;

        if (!data.paciente.notas) {
            data.paciente.notas = [];
        }

        data.paciente.notas.unshift(nuevaNota);
        guardarDatos(data.clave);

        document.getElementById(notaTextoId).value = '';
        mostrarDetalle(index, tipo);
    }
    function iniciarEdicionNota(pacienteIndex, notaIndex, tipo) {
        const data = getPacientePorIndex(pacienteIndex, tipo);
        const nota = data.paciente.notas[notaIndex];
        const notaItem = document.getElementById(`nota-item-${tipo}-${pacienteIndex}-${notaIndex}`);

        if (!notaItem) return;

        // Reemplazar contenido con formulario de edici√≥n
        notaItem.innerHTML = `
            <p style="margin: 0 0 5px 0; font-weight: 600; color: #3f51b5;">${nota.fecha} (Editando)</p>
            <textarea id="edit-nota-texto-${pacienteIndex}-${notaIndex}" rows="4" style="width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 8px;">${nota.texto}</textarea>
            <div class="nota-acciones" style="text-align: right;">
                <button style="color: #4CAF50;" onclick="guardarEdicionNota(${pacienteIndex}, ${notaIndex}, '${tipo}')">üíæ Guardar</button>
                <button class="delete" onclick="mostrarDetalle(${pacienteIndex}, '${tipo}')">‚ùå Cancelar</button>
            </div>
        `;
    }

    function guardarEdicionNota(pacienteIndex, notaIndex, tipo) {
        const nuevoTexto = document.getElementById(`edit-nota-texto-${pacienteIndex}-${notaIndex}`).value.trim();

        if (nuevoTexto === '') {
            alert('La nota no puede estar vac√≠a.');
            return;
        }

        const data = getPacientePorIndex(pacienteIndex, tipo);
        if (!data) return;

        data.paciente.notas[notaIndex].texto = nuevoTexto;
        guardarDatos(data.clave);
        alert('‚úÖ Nota modificada con √©xito.');
        mostrarDetalle(pacienteIndex, tipo); // Recargar el detalle
    }

    function eliminarNota(pacienteIndex, notaIndex, tipo) {
        const data = getPacientePorIndex(pacienteIndex, tipo);
        if (!data) return;

        const confirmacion = confirm('‚ö†Ô∏è ¬øEst√° seguro que desea eliminar esta nota?');

        if (confirmacion) {
            data.paciente.notas.splice(notaIndex, 1);
            guardarDatos(data.clave);
            alert('üóëÔ∏è Nota eliminada.');
            mostrarDetalle(pacienteIndex, tipo); // Recargar el detalle
        }
    }

    // --- FUNCIONES DE NAVEGACI√ìN Y VISUALIZACI√ìN ---

    function mostrarSeccion(id) {
        renderizarAlertas();
        listContainerEmb.classList.remove('consulta-activa');
        listContainerPuerp.classList.remove('consulta-activa');
        if (listContainerArch) listContainerArch.classList.remove('consulta-activa'); // Reiniciar listado archivado

        document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));

        document.getElementById(id).classList.add('active');

        if (id === 'registro') {
            regresarAMenuRegistro();
        } else if (id === 'listado-embarazadas') {
            detalleEmbDiv.innerHTML = '';
            renderizarListadoEmbarazadas();
        } else if (id === 'listado-puerperas') {
            detallePuerpDiv.innerHTML = '';
            renderizarListadoPuerperas();
        } else if (id === 'listado-archivadas') { // NUEVO: Listado de archivadas
            detalleArchDiv.innerHTML = '';
            renderizarListadoArchivadas();
        }
    }

    function mostrarRegistroSub(id) {
        menuRegistroTipo.style.display = 'none';

        document.querySelectorAll('#registro .sub-section').forEach(sub => sub.classList.remove('active'));

        document.getElementById(id).classList.add('active');
    }

    function iniciarRegistroDirecto(tipo) {
        mostrarSeccion('registro');

        menuRegistroTipo.style.display = 'none';

        if (tipo === 'embarazada') {
            document.getElementById('form-embarazada').classList.add('active');
            document.getElementById('form-puerpera').classList.remove('active');
            document.querySelector('input[name="metodo_calc"][value="FUR"]').checked = true;
            toggleFurFusFields('FUR');
        } else if (tipo === 'puerpera') {
            document.getElementById('form-puerpera').classList.add('active');
            document.getElementById('form-embarazada').classList.remove('active');
        }
    }

    function regresarAMenuRegistro() {
        document.getElementById('form-embarazada').classList.remove('active');
        document.getElementById('form-puerpera').classList.remove('active');

        if (document.querySelector('input[name="metodo_calc"]')) {
            document.querySelector('input[name="metodo_calc"][value="FUR"]').checked = true;
            toggleFurFusFields('FUR');
        }

        menuRegistroTipo.style.display = 'block';
    }

    function regresarAListado(tipo) {
        if (tipo === 'embarazada') {
             listContainerEmb.classList.remove('consulta-activa');
             detalleEmbDiv.innerHTML = '';
             renderizarListadoEmbarazadas();
        } else if (tipo === 'puerpera') {
             listContainerPuerp.classList.remove('consulta-activa');
             detallePuerpDiv.innerHTML = '';
             renderizarListadoPuerperas();
        } else if (tipo === 'archivada') {
             listContainerArch.classList.remove('consulta-activa');
             detalleArchDiv.innerHTML = '';
             renderizarListadoArchivadas();
        }
    }

    function renderizarListadoEmbarazadas() {
        const ul = document.getElementById('lista-nombres-embarazadas');
        ul.innerHTML = '';

        if (embarazadas.length === 0) {
            ul.innerHTML = '<li>No hay pacientes registradas.</li>';
            return;
        }

        embarazadas.forEach((p, index) => {
            const li = document.createElement('li');
            li.textContent = p.nombre;
            li.onclick = () => mostrarDetalle(index, 'embarazada');
            ul.appendChild(li);
        });
    }

    function renderizarListadoPuerperas() {
        const ul = document.getElementById('lista-nombres-puerperas');
        ul.innerHTML = '';

        if (puerperas.length === 0) {
            ul.innerHTML = '<li>No hay pacientes registradas.</li>';
            return;
        }

        puerperas.forEach((p, index) => {
            const li = document.createElement('li');
            li.textContent = p.nombre;
            li.onclick = () => mostrarDetalle(index, 'puerpera');
            ul.appendChild(li);
        });
    }

    // NUEVA FUNCI√ìN PARA RENDERIZAR ARCHIVADAS (CORREGIDA)
    function renderizarListadoArchivadas() {
        const ul = document.getElementById('lista-nombres-archivadas');
        ul.innerHTML = '';

        if (archivadas.length === 0) {
            ul.innerHTML = '<li>No hay pacientes archivadas.</li>';
            return;
        }

        // Ordenar por tipo y luego por nombre para la visualizaci√≥n
        const sortedArchivadas = [...archivadas].sort((a, b) => a.tipo.localeCompare(b.tipo) || a.nombre.localeCompare(b.nombre));

        sortedArchivadas.forEach((p) => {
            // CORRECCI√ìN: Buscamos el √≠ndice real en la lista original 'archivadas'
            const originalIndex = archivadas.indexOf(p);

            const li = document.createElement('li');
            li.textContent = `[${p.tipo === 'embarazada' ? 'E' : 'P'}] ${p.nombre}`;

            // Usamos originalIndex en lugar de index
            li.onclick = () => mostrarDetalleArchivada(originalIndex);

            ul.appendChild(li);
        });
    }

// --- FUNCI√ìN PARA MOSTRAR/OCULTAR HISTORIAL EMBARAZO ---
     function toggleHistorial(index) {
         const div = document.getElementById(`historial-embarazo-${index}`);
         if (div.style.display === 'none') {
         div.style.display = 'block';
         div.style.animation = 'fadeIn 0.5s';
         } else {
        div.style.display = 'none';
    }
}

        function mostrarDetalle(index, tipo) {
        const targetDiv = (tipo === 'embarazada') ? detalleEmbDiv : detallePuerpDiv;
        const targetContainer = (tipo === 'embarazada') ? listContainerEmb : listContainerPuerp;

        targetContainer.classList.add('consulta-activa');
        targetDiv.innerHTML = '';

        // ==========================================
        // L√ìGICA PARA EMBARAZADA
        // ==========================================
        if (tipo === 'embarazada') {
            const p = embarazadas[index];
            const furDate = getEffectiveFURDate(p);

            // Datos b√°sicos
            let edadDisplay = p.fecha_nacimiento ? `${calcularEdad(crearFechaLocal(p.fecha_nacimiento))} a√±os` : 'N/A';
            const fppDate = calcularFPP(furDate);
            const gestacion = calcularEdadGestacional(furDate);

            // L√≥gica de visualizaci√≥n de semanas (Color y mensaje)
            let highlightClass = 'dato-destacado-box';
            let restanteMsg;
            if (gestacion.diasRestantes <= 0) {
                highlightClass += ' alerta';
                restanteMsg = `‚ö†Ô∏è Parto completado o Post-T√©rmino`;
            } else {
                const semanasRestantes = Math.ceil(gestacion.diasRestantes / 7);
                restanteMsg = `FPP estimada en ${semanasRestantes} semanas`;
            }

            // L√≥gica Fuente de c√°lculo
            let fuenteTexto = (p.metodo === 'FUS') ? `Ultrasonido (${formatDate(crearFechaLocal(p.fus_date))})` : 'Fecha √öltima Regla';
            let furLabel = (p.metodo === 'FUS') ? 'FUR Calculada' : 'FUR';

            // Helper para vacunas
            const v = p.vacunas || {};
            const checkVac = (date) => date ? `<span class="status-ok">Aplicada el ${formatDate(crearFechaLocal(date))}</span>` : `<span class="status-pending">Pendiente</span>`;

            // HTML ESTRUCTURA DE FICHA EMBARAZADA
            targetDiv.innerHTML = `
                <div id="vista-info-emb-${index}" class="ficha-container">
                    <div class="ficha-header header-emb">
                        <div>
                            <h3>${p.nombre}</h3>
                            <small style="opacity:0.9">ID/Exp: ${index + 1}</small>
                        </div>
                        <span class="ficha-badge">ü§∞ Embarazada</span>
                    </div>

                    <div class="ficha-body">
                        <div class="${highlightClass}">
                            <span class="dato-label">Edad Gestacional Actual</span>
                            <span class="dato-grande">${gestacion.semanas} Semanas <small style="font-size:0.5em">+ ${gestacion.dias} d√≠as</small></span>
                            <span class="dato-sub">${restanteMsg}</span>
                        </div>

                        <div class="datos-grid">
                            <div class="dato-item">
                                <span class="dato-label">Edad Paciente</span>
                                <span class="dato-valor">${edadDisplay}</span>
                            </div>
                            <div class="dato-item">
                                <span class="dato-label">Fecha Probable Parto</span>
                                <span class="dato-valor" style="color:#d81b60">${formatDate(fppDate)}</span>
                            </div>
                            <div class="dato-item">
                                <span class="dato-label">${furLabel}</span>
                                <span class="dato-valor">${formatDate(furDate)}</span>
                            </div>
                            <div class="dato-item">
                                <span class="dato-label">C√°lculo Basado en</span>
                                <span class="dato-valor">${fuenteTexto}</span>
                            </div>
                        </div>

                        <h4 class="seccion-titulo">üíâ Esquema de Vacunaci√≥n</h4>
                        <table class="tabla-vacunas">
                            <tr><td width="30%"><strong>Influenza</strong></td><td>${checkVac(v.influenza)}</td></tr>
                            <tr><td><strong>DTPa</strong></td><td>${checkVac(v.dtpa)}</td></tr>
                            <tr><td><strong>DT Adulto</strong></td><td>${checkVac(v.dtadulto)}</td></tr>
                            <tr><td><strong>VRS</strong></td><td>${checkVac(v.vrs)}</td></tr>
                        </table>

                        <h4 class="seccion-titulo">üìù Notas Cl√≠nicas (${p.notas ? p.notas.length : 0})</h4>
                        <div id="notas-list-emb-${index}">
                            ${renderizarNotas(p, index, 'embarazada')}
                        </div>
                    </div>
                </div>

                <form onsubmit="event.preventDefault(); a√±adirNota(${index}, 'embarazada');" style="margin-top: 15px; padding: 0 10px;">
                    <textarea id="nueva-nota-embarazada" rows="2" placeholder="Escribir nueva nota..." style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px;"></textarea>
                    <button type="submit" class="btn-guardar" style="margin-top: 5px; padding: 8px;">Agregar Nota</button>
                </form>

                <div class="control-panel">
                    <div class="control-header">Acciones del Expediente</div>
                    <div class="btn-grid">
                        <button class="btn-pro pro-birth full-width" onclick="finalizarEmbarazo(${index})">
                            <span>üë∂</span> ¬°Registrar Parto! (Pasar a Puerperio)
                        </button>
                        <button class="btn-pro pro-pdf full-width" onclick="descargarPDF(${index}, 'embarazada')">
                            <span>üìÑ</span> Descargar ficha PDF
                        </button>
                        <button class="btn-pro pro-edit" onclick="iniciarEdicion(${index}, 'embarazada')">
                            <span>‚úèÔ∏è</span> Editar
                        </button>
                        <button class="btn-pro pro-archive" onclick="archivarPaciente(${index}, 'embarazada')">
                            <span>üì¶</span> Archivar
                        </button>
                        <button class="btn-pro pro-delete full-width" onclick="eliminarPaciente(${index}, 'embarazada')">
                            <span>üóëÔ∏è</span> Eliminar
                        </button>
                        <button class="btn-pro pro-back" onclick="regresarAListado('embarazada')">
                            ‚Üê Volver al Listado
                        </button>
                    </div>
                </div>
            `;

        // ==========================================
        // L√ìGICA PARA PU√âRPERA (CON SEMANAS AL NACER AGREGADO)
        // ==========================================
        } else if (tipo === 'puerpera') {
            const p = puerperas[index];
            const fpDate = crearFechaLocal(p.fp);
            let edadDisplay = p.fecha_nacimiento ? `${calcularEdad(crearFechaLocal(p.fecha_nacimiento))} a√±os` : 'N/A';
            const puerperio = calcularPuerperio(fpDate);
            const seg = calcularFechasSeguimientoPuerpera(fpDate);

            // Estilos condicionales
            let highlightClass = 'dato-destacado-box';
            let estadoMsg;
            if (puerperio.diasRestantes <= 0) {
                 highlightClass += ' alerta';
                 estadoMsg = `Puerperio finalizado hace ${Math.abs(puerperio.diasRestantes)} d√≠as`;
            } else {
                 estadoMsg = `Faltan ${puerperio.diasRestantes} d√≠as para el alta`;
            }

            // Helper seguimiento
            const rowSeg = (label, date) => `
                <div class="dato-item">
                    <span class="dato-label">${label}</span>
                    <span class="dato-valor">${formatDate(date)}</span>
                </div>`;

            // --- L√ìGICA HISTORIAL Y SEMANAS AL NACER ---
            let botonHistorialHTML = '';
            let contenedorHistorialHTML = '';

            if (p.historial_embarazo) {
                const h = p.historial_embarazo;
                const vac = h.vacunas || {};

                // CALCULO DE SEMANAS AL NACER
                const furEfectiva = getEffectiveFURDate(h); // Usamos la misma funci√≥n que para embarazadas pero pasamos el historial
                const semanasAlNacer = calcularEdadGestacionalAlParto(furEfectiva, fpDate);

                const checkV = (date) => date ? `<span class="status-ok">S√≠ (${formatDate(crearFechaLocal(date))})</span>` : `<span class="status-pending">No</span>`;

                botonHistorialHTML = `
                    <button onclick="toggleHistorial(${index})" style="background-color: #673ab7; color: white; border:none; padding: 10px; width:100%; border-radius: 8px; margin-bottom: 15px; cursor: pointer; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <span>üìú</span> Ver Historial de Embarazo Anterior
                    </button>
                `;

                contenedorHistorialHTML = `
                    <div id="historial-embarazo-${index}" style="display: none; background-color: #f3e5f5; padding: 15px; border-radius: 8px; border-left: 5px solid #673ab7; margin-bottom: 20px;">
                        <h4 style="color: #673ab7; margin-top: 0;">ü§∞ Historial del Embarazo Finalizado</h4>

                        <div style="background: white; padding: 10px; border-radius: 6px; margin-bottom: 10px; border: 1px solid #d1c4e9; text-align: center;">
                             <span style="font-size: 0.8em; color: #673ab7; font-weight: bold; text-transform: uppercase;">Finaliz√≥ a las:</span>
                             <div style="font-size: 1.4em; font-weight: bold; color: #4a148c;">${semanasAlNacer}</div>
                        </div>

                        <div class="datos-grid">
                            <div class="dato-item">
                                <span class="dato-label">M√©todo C√°lculo</span>
                                <span class="dato-valor">${h.metodo}</span>
                            </div>
                            <div class="dato-item">
                                <span class="dato-label">FUR / FUS</span>
                                <span class="dato-valor">${h.metodo === 'FUR' ? formatDate(crearFechaLocal(h.fur)) : formatDate(crearFechaLocal(h.fus_date))}</span>
                            </div>
                        </div>

                        <h5 style="color: #4a148c; border-bottom: 1px solid #d1c4e9; margin-bottom: 5px;">üíâ Vacunas Aplicadas en Embarazo</h5>
                        <ul style="list-style: none; padding: 0; font-size: 0.9em;">
                            <li><strong>Influenza:</strong> ${checkV(vac.influenza)}</li>
                            <li><strong>DTPa:</strong> ${checkV(vac.dtpa)}</li>
                            <li><strong>DT Adulto:</strong> ${checkV(vac.dtadulto)}</li>
                            <li><strong>VRS:</strong> ${checkV(vac.vrs)}</li>
                        </ul>
                    </div>
                `;
            }
            // ------------------------------------------

            targetDiv.innerHTML = `
                <div id="vista-info-puerp-${index}" class="ficha-container">
                    <div class="ficha-header header-puerp">
                        <div>
                            <h3>${p.nombre}</h3>
                            <small style="opacity:0.9">ID/Exp: ${index + 1}</small>
                        </div>
                        <span class="ficha-badge">ü§± Pu√©rpera</span>
                    </div>

                    <div class="ficha-body">
                        ${botonHistorialHTML}
                        ${contenedorHistorialHTML}

                        <div class="${highlightClass}">
                            <span class="dato-label">Progreso del Puerperio</span>
                            <span class="dato-grande">${puerperio.diasPuerperio} <small>d√≠as transcurridos</small></span>
                            <span class="dato-sub">${estadoMsg}</span>
                        </div>

                        <div class="datos-grid">
                            <div class="dato-item">
                                <span class="dato-label">Edad Paciente</span>
                                <span class="dato-valor">${edadDisplay}</span>
                            </div>
                            <div class="dato-item">
                                <span class="dato-label">Fecha de Parto</span>
                                <span class="dato-valor">${formatDate(fpDate)}</span>
                            </div>
                            <div class="dato-item">
                                <span class="dato-label">Fin Puerperio (42 d√≠as)</span>
                                <span class="dato-valor" style="color:#e91e63; font-weight:bold;">${formatDate(puerperio.finPuerperioDate)}</span>
                            </div>
                        </div>

                        <h4 class="seccion-titulo">üóìÔ∏è Calendario de Seguimiento</h4>
                        <div class="datos-grid">
                            ${rowSeg('Detecci√≥n (24h)', seg['24 horas'])}
                            ${rowSeg('Control 3 D√≠as', seg['3 d√≠as'])}
                            ${rowSeg('Control 7 D√≠as', seg['7 d√≠as'])}
                            ${rowSeg('Control 15 D√≠as', seg['15 d√≠as'])}
                            ${rowSeg('Control 28 D√≠as', seg['28 d√≠as'])}
                        </div>

                        <h4 class="seccion-titulo">üìù Notas Cl√≠nicas (${p.notas ? p.notas.length : 0})</h4>
                        <div id="notas-list-puerp-${index}">
                            ${renderizarNotas(p, index, 'puerpera')}
                        </div>
                    </div>
                </div>

                <form onsubmit="event.preventDefault(); a√±adirNota(${index}, 'puerpera');" style="margin-top: 15px; padding: 0 10px;">
                    <textarea id="nueva-nota-puerpera" rows="2" placeholder="Escribir nueva nota..." style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px;"></textarea>
                    <button type="submit" class="btn-guardar" style="margin-top: 5px; padding: 8px;">Agregar Nota</button>
                </form>


                <div class="control-panel">
                    <div class="control-header">Acciones del Expediente</div>
                    <div class="btn-grid">
                        <button class="btn-pro pro-pdf full-width" onclick="descargarPDF(${index}, 'puerpera')">
                            <span>üìÑ</span> Descargar Ficha PDF
                        </button>

                        <button class="btn-pro pro-edit" onclick="iniciarEdicion(${index}, 'puerpera')">
                            <span>‚úèÔ∏è</span> Corregir
                        </button>
                        <button class="btn-pro pro-archive" onclick="archivarPaciente(${index}, 'puerpera')">
                            <span>üì¶</span> Archivar
                        </button>

                        <button class="btn-pro pro-delete full-width" onclick="eliminarPaciente(${index}, 'puerpera')">
                            <span>üóëÔ∏è</span> Eliminar Paciente
                        </button>

                        <button class="btn-pro pro-back full-width" onclick="regresarAListado('puerpera')">
                            ‚Üê Volver al Listado
                        </button>
                    </div>
                </div>

            `;
        }
    }

        function mostrarDetalleArchivada(index) {
        const p = archivadas[index];
        listContainerArch.classList.add('consulta-activa');
        detalleArchDiv.innerHTML = '';

        // Datos comunes
        const fnDisplay = p.fecha_nacimiento ? formatDate(crearFechaLocal(p.fecha_nacimiento)) : 'N/A';
        const fechaArchivo = p.fecha_archivo ? formatDate(crearFechaLocal(p.fecha_archivo)) : 'Desconocida';

        let contenidoEspecifico = '';

        // --- CASO 1: ARCHIVADA DESDE EMBARAZO (Interrupci√≥n o Traslado) ---
        if (p.tipo === 'embarazada') {
            const furDate = getEffectiveFURDate(p);
            const v = p.vacunas || {};
            // Helper para mostrar s√≠/no en vacunas
            const checkVac = (date) => date ? `<span class="status-ok">S√≠ (${formatDate(crearFechaLocal(date))})</span>` : `<span class="status-pending">No registrada</span>`;

            contenidoEspecifico = `
                <div class="dato-destacado-box" style="background-color: #eceff1; border-left: 5px solid #607d8b;">
                    <span class="dato-label">Motivo de Archivo</span>
                    <span class="dato-grande">Embarazo Finalizado</span>
                    <span class="dato-sub">Archivada directamente desde etapa gestacional</span>
                </div>

                <h4 class="seccion-titulo">ü§∞ Datos del Embarazo</h4>
                <div class="datos-grid">
                    <div class="dato-item"><span class="dato-label">FUR / FUS</span><span class="dato-valor">${formatDate(furDate)}</span></div>
                    <div class="dato-item"><span class="dato-label">M√©todo C√°lculo</span><span class="dato-valor">${p.metodo}</span></div>
                </div>

                <h4 class="seccion-titulo">üíâ Registro de Vacunaci√≥n</h4>
                <table class="tabla-vacunas">
                    <tr><td width="40%"><strong>Influenza</strong></td><td>${checkVac(v.influenza)}</td></tr>
                    <tr><td><strong>DTPa</strong></td><td>${checkVac(v.dtpa)}</td></tr>
                    <tr><td><strong>DT Adulto</strong></td><td>${checkVac(v.dtadulto)}</td></tr>
                    <tr><td><strong>VRS</strong></td><td>${checkVac(v.vrs)}</td></tr>
                </table>
            `;
        }
        // --- CASO 2: ARCHIVADA DESDE PUERPERIO (Ciclo Completo) ---
        else {
            const fpDate = crearFechaLocal(p.fp);

            // Verificar si tiene historial del embarazo anterior
            let historialHTML = '';
            if (p.historial_embarazo) {
                const h = p.historial_embarazo;
                const vac = h.vacunas || {};
                const checkV = (date) => date ? `<b>S√≠</b> <small>(${formatDate(crearFechaLocal(date))})</small>` : `<small style="color:#999">No</small>`;

                // --- CALCULO DE SEMANAS AL NACER PARA ARCHIVADAS ---
                const furEfectiva = getEffectiveFURDate(h);
                const semanasAlNacer = calcularEdadGestacionalAlParto(furEfectiva, fpDate);

                historialHTML = `
                    <div style="margin-top: 25px; padding: 15px; background: #f9fbe7; border: 1px solid #cddc39; border-radius: 8px;">
                        <h4 style="margin-top:0; color: #827717; border-bottom: 1px solid #cddc39; padding-bottom: 5px;">üìú Historial del Embarazo (Previo al Parto)</h4>

                        <div style="margin-bottom:10px; font-weight:bold; color: #827717;">
                            Finaliz√≥ a las: <span style="font-size:1.2em; color:#33691e;">${semanasAlNacer}</span>
                        </div>

                        <div class="datos-grid" style="margin-bottom: 10px;">
                             <div class="dato-item"><span class="dato-label">M√©todo Usado</span><span class="dato-valor">${h.metodo}</span></div>
                             <div class="dato-item"><span class="dato-label">Fecha Ref (FUR/FUS)</span><span class="dato-valor">${h.metodo === 'FUR' ? formatDate(crearFechaLocal(h.fur)) : formatDate(crearFechaLocal(h.fus_date))}</span></div>
                        </div>

                        <span class="dato-label" style="margin-bottom: 5px; display:block;">Vacunas Aplicadas durante la gestaci√≥n:</span>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; font-size: 0.9em;">
                            <div>Influenza: ${checkV(vac.influenza)}</div>
                            <div>DTPa: ${checkV(vac.dtpa)}</div>
                            <div>DT Adulto: ${checkV(vac.dtadulto)}</div>
                            <div>VRS: ${checkV(vac.vrs)}</div>
                        </div>
                    </div>
                `;
            }

            contenidoEspecifico = `
                <div class="dato-destacado-box" style="background-color: #e3f2fd; border-left: 5px solid #2196f3;">
                    <span class="dato-label">Estado del Expediente</span>
                    <span class="dato-grande">Ciclo Materno Concluido</span>
                    <span class="dato-sub">Puerperio finalizado (>42 d√≠as)</span>
                </div>

                <h4 class="seccion-titulo">ü§± Datos del Parto y Puerperio</h4>
                <div class="datos-grid">
                    <div class="dato-item"><span class="dato-label">Fecha de Parto (FP)</span><span class="dato-valor">${formatDate(fpDate)}</span></div>
                    <div class="dato-item"><span class="dato-label">Fin Puerperio</span><span class="dato-valor">${formatDate(calcularFinPuerperio(fpDate))}</span></div>
                </div>

                ${historialHTML}
            `;
        }

        // --- RENDERIZADO FINAL (ESTRUCTURA FICHA PARA PDF) ---
        detalleArchDiv.innerHTML = `
            <div id="vista-info-arch-${index}" class="ficha-container" style="border-top: 5px solid #607d8b;">
                <div class="ficha-header header-arch">
                    <div>
                        <h3>${p.nombre}</h3>
                        <small>Fecha de Archivo: ${fechaArchivo}</small>
                    </div>
                    <span class="ficha-badge">üì¶ Expediente Hist√≥rico</span>
                </div>

                <div class="ficha-body">
                    <div class="datos-grid">
                        <div class="dato-item">
                            <span class="dato-label">Edad Actual</span>
                            <span class="dato-valor">${p.fecha_nacimiento ? calcularEdad(crearFechaLocal(p.fecha_nacimiento)) + ' a√±os' : 'N/A'}</span>
                        </div>
                        <div class="dato-item">
                            <span class="dato-label">Fecha Nacimiento</span>
                            <span class="dato-valor">${fnDisplay}</span>
                        </div>
                    </div>

                    ${contenidoEspecifico}

                    <h4 class="seccion-titulo" style="margin-top: 30px;">üìù Historial Completo de Notas</h4>
                    <div style="max-height: none; overflow: visible;">
                        ${renderizarNotas(p, index, 'archivada')}
                    </div>

                    <div style="margin-top: 20px; text-align: center; font-size: 0.8em; color: #999;">
                        --- Fin del Documento Cl√≠nico ---
                    </div>
                </div>
            </div>


            <div class="control-panel" style="border-top: 4px solid #607d8b;">
                <div class="control-header">Gesti√≥n de Archivo</div>
                <div class="btn-grid">
                    <button class="btn-pro pro-pdf full-width" onclick="descargarPDF(${index}, 'archivada')">
                        <span>üìÑ</span> Ficha PDF Completa
                    </button>

                    <button class="btn-pro full-width" style="background: linear-gradient(135deg, #ffa000, #ff6f00);" onclick="restaurarPaciente(${index})">
                        <span>üîÑ</span> Restaurar a Lista Activa
                    </button>

                    <button class="btn-pro pro-delete full-width" onclick="eliminarPaciente(${index}, 'archivada')">
                        <span>üóëÔ∏è</span> Eliminar Definitivamente
                    </button>

                    <button class="btn-pro pro-back" onclick="regresarAListado('archivada')">
                        ‚Üê Volver
                    </button>
                    <button class="btn-pro pro-back" onclick="mostrarSeccion('inicio')">
                        üè† Men√∫
                    </button>
                </div>
            </div>
        `;
    }


    // NUEVA FUNCI√ìN PARA ARICHIVAR PACIENTE
    function archivarPaciente(index, tipo) {
        let paciente;
        let listaActual;
        let listaNombre;

        if (tipo === 'embarazada') {
            paciente = embarazadas.splice(index, 1)[0];
            listaActual = 'embarazadas';
            listaNombre = 'Embarazadas';
        } else if (tipo === 'puerpera') {
            paciente = puerperas.splice(index, 1)[0];
            listaActual = 'puerperas';
            listaNombre = 'Pu√©rperas';
        }

        if (paciente) {
            paciente.tipo = tipo; // A√±adir el tipo original antes de archivar
            paciente.fecha_archivo = obtenerFechaLocalISO();
            archivadas.push(paciente);

            guardarDatos(listaActual);
            guardarDatos('archivadas');

            alert(`‚úÖ Paciente ${paciente.nombre} archivada correctamente. Ahora est√° en la lista de Pacientes Archivadas.`);
            regresarAListado(tipo);
        }
    }

    // NUEVA FUNCI√ìN PARA RESTAURAR PACIENTE
    function restaurarPaciente(index) {
        const paciente = archivadas.splice(index, 1)[0];

        if (paciente) {
            const tipo = paciente.tipo;
            delete paciente.tipo;
            delete paciente.fecha_archivo;

            if (tipo === 'embarazada') {
                embarazadas.push(paciente);
                guardarDatos('embarazadas');
            } else if (tipo === 'puerpera') {
                puerperas.push(paciente);
                guardarDatos('puerperas');
            }

            guardarDatos('archivadas');

            alert(`‚úÖ Paciente ${paciente.nombre} restaurada a la lista de ${tipo === 'embarazada' ? 'Embarazadas' : 'Pu√©rperas'}.`);

            regresarAListado('archivada'); // Vuelve al listado de archivadas
        }
    }

    // FUNCI√ìN DE ELIMINAR PACIENTE MODIFICADA
    function eliminarPaciente(index, tipo) {
        let lista;
        let listaNombre;
        let claveGuardado;

        if (tipo === 'embarazada') {
            lista = embarazadas;
            claveGuardado = 'embarazadas';
            listaNombre = 'Embarazadas';
        } else if (tipo === 'puerpera') {
            lista = puerperas;
            claveGuardado = 'puerperas';
            listaNombre = 'Pu√©rperas';
        } else if (tipo === 'archivada') {
            lista = archivadas;
            claveGuardado = 'archivadas';
            listaNombre = 'Archivadas';
        }

        const nombre = lista[index].nombre;

        const confirmMsg = `‚ö†Ô∏è ¬øEst√°s seguro de que deseas ELIMINAR PERMANENTEMENTE a ${nombre} del registro de ${listaNombre}? Esta acci√≥n NO se puede deshacer.`;

        if (confirm(confirmMsg)) {
            lista.splice(index, 1);
            guardarDatos(claveGuardado);

            alert(`üóëÔ∏è Paciente ${nombre} eliminada permanentemente.`);

            regresarAListado(tipo);
        }
    }

    // --- FUNCIONES DE EDICI√ìN ---

    function iniciarEdicion(index, tipo) {
        const p = (tipo === 'embarazada') ? embarazadas[index] : puerperas[index];
        const fechaKey = (tipo === 'embarazada') ? 'fur' : 'fp';

        const fechaEtiqueta = (tipo === 'embarazada')
            ? (p.metodo === 'FUS' ? 'Nueva FUR Equivalente' : 'Nueva FUR')
            : 'Nueva FP';

        const contenedorInfo = document.getElementById(`vista-info-${(tipo === 'embarazada') ? 'emb' : 'puerp'}-${index}`);
        const fnValue = p.fecha_nacimiento || '';

        const vacunas = p.vacunas || {};

        contenedorInfo.innerHTML = `
            <h3>Corregir Datos de ${p.nombre}</h3>
            <form onsubmit="event.preventDefault(); guardarEdicion(${index}, '${tipo}');">
                <label for="edit-nombre">Nuevo Nombre:</label>
                <input type="text" id="edit-nombre-${tipo}" value="${p.nombre}" required>

                <label for="edit-fn">Nueva Fecha de Nacimiento (Opcional):</label>
                <input type="date" id="edit-fn-${tipo}" value="${fnValue}">

                <label for="edit-fecha">${fechaEtiqueta}:</label>
                <input type="date" id="edit-fecha-${tipo}" value="${p[fechaKey]}" required>

                ${tipo === 'embarazada' ? `
                    <hr>
                    <h4>üíâ Corregir Fechas de Vacunas</h4>
                    <label for="edit-influenza">Influenza:</label>
                    <input type="date" id="edit-influenza-embarazada" value="${vacunas.influenza || ''}">

                    <label for="edit-dtpa">DTPa:</label>
                    <input type="date" id="edit-dtpa-embarazada" value="${vacunas.dtpa || ''}">

                    <label for="edit-dtadulto">DT Adulto:</label>
                    <input type="date" id="edit-dtadulto-embarazada" value="${vacunas.dtadulto || ''}">

                    <label for="edit-vrs">VRS:</label>
                    <input type="date" id="edit-vrs-embarazada" value="${vacunas.vrs || ''}">
                ` : ''}

                <div class="detalle-actions" style="margin-top: 15px;">
                    <button type="submit" class="btn-guardar" style="max-width: 300px;">üíæ Guardar Cambios</button>
                    <button type="button" class="btn-accion eliminar" style="background-color: #7986cb;" onclick="mostrarDetalle(${index}, '${tipo}')" style="max-width: 300px;">Cancelar</button>
                </div>
            </form>
        `;
    }

    function guardarEdicion(index, tipo) {
        const nuevoNombre = document.getElementById(`edit-nombre-${tipo}`).value.trim();
        const nuevaFechaNacimiento = document.getElementById(`edit-fn-${tipo}`).value;
        const nuevaFechaPrincipal = document.getElementById(`edit-fecha-${tipo}`).value;

        if (nuevoNombre && nuevaFechaPrincipal) {
            if (tipo === 'embarazada') {
                const nuevaInfluenza = document.getElementById('edit-influenza-embarazada').value;
                const nuevaDTPa = document.getElementById('edit-dtpa-embarazada').value;
                const nuevaDTAdulto = document.getElementById('edit-dtadulto-embarazada').value;
                const nuevaVRS = document.getElementById('edit-vrs-embarazada').value;

                embarazadas[index].nombre = nuevoNombre;
                embarazadas[index].fecha_nacimiento = nuevaFechaNacimiento;
                embarazadas[index].fur = nuevaFechaPrincipal;

                embarazadas[index].vacunas = {
                    influenza: nuevaInfluenza,
                    dtpa: nuevaDTPa,
                    dtadulto: nuevaDTAdulto,
                    vrs: nuevaVRS
                };
                embarazadas[index].metodo = embarazadas[index].metodo || 'FUR';

                guardarDatos('embarazadas');
            } else if (tipo === 'puerpera') {
                puerperas[index].nombre = nuevoNombre;
                puerperas[index].fecha_nacimiento = nuevaFechaNacimiento;
                puerperas[index].fp = nuevaFechaPrincipal;
                guardarDatos('puerperas');
            }

            alert(`‚úÖ Datos de ${nuevoNombre} corregidos con √©xito.`);

            mostrarDetalle(index, tipo);
        } else {
            alert('Por favor, ingresa un nombre y la fecha principal (FUR/FP) v√°lidos.');
        }
    }

    // --- MANEJO DE REGISTRO ---

    document.getElementById('registro-form-embarazada').addEventListener('submit', function(e) {
        e.preventDefault();
        const nombre = document.getElementById('nombre-emb').value.trim();
        const fecha_nacimiento = document.getElementById('fn-emb').value;
        const metodo = document.querySelector('input[name="metodo_calc"]:checked').value;

        const vacunaInfluenza = document.getElementById('vacuna-influenza').value;
        const vacunaDTPa = document.getElementById('vacuna-dtpa').value;
        const vacunaDTAdulto = document.getElementById('vacuna-dtadulto').value;
        const vacunaVRS = document.getElementById('vacuna-vrs').value;

        let nuevoRegistro = {
            nombre,
            fecha_nacimiento,
            metodo,
            vacunas: {
                influenza: vacunaInfluenza,
                dtpa: vacunaDTPa,
                dtadulto: vacunaDTAdulto,
                vrs: vacunaVRS
            },
            notas: [] // Inicializar array de notas
        };

        if (metodo === 'FUR') {
            const fur = document.getElementById('fur').value;
            if (!nombre || !fur) {
                alert('El nombre y la FUR son obligatorios.');
                return;
            }
            nuevoRegistro.fur = fur;

        } else if (metodo === 'FUS') {
            const fus_date = document.getElementById('fus_date').value;
            const egus_weeks = parseInt(document.getElementById('egus_weeks').value);
            const egus_days = parseInt(document.getElementById('egus_days').value);

            if (!nombre || !fus_date || isNaN(egus_weeks) || isNaN(egus_days)) {
                alert('El nombre, la Fecha de Ultrasonido y la Edad Gestacional por US son obligatorios.');
                return;
            }

            const fur = calcularFURDesdeUS(crearFechaLocal(fus_date), egus_weeks, egus_days);

            nuevoRegistro.fur = fur;
            nuevoRegistro.fus_date = fus_date;
            nuevoRegistro.egus_weeks = egus_weeks;
            nuevoRegistro.egus_days = egus_days;
        } else {
            alert('Por favor, selecciona una fuente de c√°lculo.');
            return;
        }

        embarazadas.push(nuevoRegistro);
        guardarDatos('embarazadas');
        this.reset();
        alert(`‚úÖ Embarazada ${nombre} registrada con √©xito. Fuente: ${metodo}`);
        mostrarSeccion('listado-embarazadas');
    });

    document.getElementById('registro-form-puerpera').addEventListener('submit', function(e) {
        e.preventDefault();
        const nombre = document.getElementById('nombre-puerp').value.trim();
        const fecha_nacimiento = document.getElementById('fn-puerp').value;
        const fp = document.getElementById('fp').value;

        if (nombre && fp) {
            puerperas.push({ nombre, fecha_nacimiento, fp, notas: [] }); // Inicializar array de notas
            guardarDatos('puerperas');
            this.reset();
            alert(`‚úÖ Pu√©rpera ${nombre} registrada.`);
            mostrarSeccion('listado-puerperas');
        } else {
            alert('El nombre y la Fecha de Parto (FP) son obligatorios.');
        }
    });

    // --- INICIALIZACI√ìN ---
    document.addEventListener('DOMContentLoaded', () => {
        mostrarSeccion('inicio');
            verificarAutoArchivo(); // <--- Activa la limpieza autom√°tica

        // Asegura que al cargar la p√°gina por primera vez se configure el formulario de embarazada correctamente
        if (document.querySelector('input[name="metodo_calc"]')) {
            toggleFurFusFields('FUR');
        }

        /*
         * SE ELIMIN√ì EL BLOQUE "setInterval" para evitar que el rec√°lculo autom√°tico
         * de la edad gestacional/puerperio interrumpa y borre el texto de las notas
         * que el usuario est√° escribiendo.
         * * La informaci√≥n de las pacientes se recalcular√° autom√°ticamente
         * cada vez que se haga clic sobre una paciente para ver su detalle.
        */
    });

    // Variable para recordar a qui√©n estamos editando mientras la ventana est√° abierta
let indexTempParto = null;

function finalizarEmbarazo(index) {
    indexTempParto = index; // Guardamos el ID de la paciente
    const paciente = embarazadas[index];

    // Poner nombre en la ventana
    document.getElementById('nombre-paciente-parto').innerText = paciente.nombre;

    // --- CORRECCI√ìN DE ZONA HORARIA ---
    // En lugar de toISOString(), construimos la fecha localmente:
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0'); // Meses van de 0 a 11, sumamos 1
    const day = String(now.getDate()).padStart(2, '0');

    const hoy = `${year}-${month}-${day}`;
    // ----------------------------------

    document.getElementById('fecha-parto-calendario').value = hoy;

    // Mostrar la ventana
    document.getElementById('modal-parto').style.display = 'flex';
}


function confirmarParto() {
        if (indexTempParto === null) return;

        const fp = document.getElementById('fecha-parto-calendario').value;

        if (!fp) {
            alert("Por favor selecciona una fecha v√°lida.");
            return;
        }

        const paciente = embarazadas[indexTempParto];

        // --- CAMBIO: ETIQUETAR NOTAS ANTERIORES COMO 'EMBARAZO' ---
        if (paciente.notas && paciente.notas.length > 0) {
            paciente.notas.forEach(nota => {
                if (!nota.etapa) {
                    nota.etapa = 'Embarazo';
                }
            });
        }

        const datosEmbarazoPrevio = {
            fur: paciente.fur,
            metodo: paciente.metodo,
            fus_date: paciente.fus_date || null,
            egus_weeks: paciente.egus_weeks || null,
            egus_days: paciente.egus_days || null,
            vacunas: paciente.vacunas || {}
        };

        const nuevaPuerpera = {
            nombre: paciente.nombre,
            fecha_nacimiento: paciente.fecha_nacimiento,
            fp: fp,
            notas: paciente.notas || [],
            historial_embarazo: datosEmbarazoPrevio,
            origen: 'Transici√≥n autom√°tica desde Embarazo'
        };

        // Nota autom√°tica de transici√≥n
        nuevaPuerpera.notas.unshift({
            fecha: new Date().toLocaleString(),
            texto: "üîµ EVENTO: Finaliz√≥ embarazo y pas√≥ a puerperio.",
            etapa: "Sistema" // Etiqueta especial para el sistema
        });

        puerperas.push(nuevaPuerpera);
        embarazadas.splice(indexTempParto, 1);

        guardarDatos('embarazadas');
        guardarDatos('puerperas');

        cancelarParto();
        alert(`‚úÖ ¬°Registrado! ${paciente.nombre} movida a Pu√©rperas.`);
        mostrarSeccion('listado-puerperas');
    }
// 3. FUNCI√ìN PARA CERRAR (Se llama al Cancelar)
function cancelarParto() {
    document.getElementById('modal-parto').style.display = 'none';
    indexTempParto = null;
}
// --- FUNCI√ìN: AUTO-ARCHIVO (42 D√≠as) ---
function verificarAutoArchivo() {
    if (!puerperas || puerperas.length === 0) return;
    let movidas = 0;
    const hoy = new Date();
    const hoyZero = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate());

    for (let i = puerperas.length - 1; i >= 0; i--) {
        const p = puerperas[i];
        if(!p.fp) continue;
        const fp = crearFechaLocal(p.fp);
        const diffTime = hoyZero.getTime() - fp.getTime();
        const dias = Math.floor(diffTime / (1000 * 60 * 60 * 24));

        if (dias > 42) {
            p.tipo = 'puerpera';
            p.fecha_archivo = obtenerFechaLocalISO();
            if(!p.notas) p.notas = [];
            p.notas.unshift({ fecha: new Date().toLocaleString(), texto: "üì¶ SISTEMA: Puerperio finalizado (>42 d√≠as)." });

            archivadas.push(p);
            puerperas.splice(i, 1);
            movidas++;
        }
    }
    if (movidas > 0) {
        guardarDatos('puerperas');
        guardarDatos('archivadas');
        alert(`‚ÑπÔ∏è MANTENIMIENTO: Se archivaron ${movidas} pu√©rperas por finalizar periodo (>42 d√≠as).`);
    }
}
    // --- L√ìGICA DE ALERTAS (AGREGADO) ---
function calcularAlertas() {
const alertas = [];
// Usamos 'hoyZero' para comparar peras con peras (sin horas, solo fechas)
const hoy = new Date();
const hoyZero = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate());

// 1. Revisar Embarazadas
if(typeof embarazadas !== 'undefined') {
    embarazadas.forEach((p, index) => {
        // Usamos crearFechaLocal para evitar errores de zona horaria
        if(!p.fur) return;
        const fur = crearFechaLocal(p.fur);

        const diffTime = hoyZero.getTime() - fur.getTime();
        const diasTotales = Math.floor(diffTime / (1000 * 60 * 60 * 24));
        const semanas = Math.floor(diasTotales / 7);

        if (semanas === 8) alertas.push({p: p.nombre, m: 'Cumple 8 Semanas de Gestaci√≥n (Dar Seguimiento Mensual)', i: index, tipo: 'embarazada'});
        if (semanas === 12) alertas.push({p: p.nombre, m: 'Cumple 12 Semanas de gestaci√≥n (Dar Seguimiento Mensual)', i: index, tipo: 'embarazada'});
        if (semanas === 16) alertas.push({p: p.nombre, m: 'Cumple 16 semanas de gestaci√≥n (Dar Seguimiento Mensual)', i: index, tipo: 'embarazada'});
        if (semanas === 20) alertas.push({p: p.nombre, m: 'Cumple 20 Semanas de gestaci√≥n (Dar Seguimiento para aplicaci√≥n de vacuna DTPa)', i: index, tipo: 'embarazada'});
        if (semanas === 24) alertas.push({p: p.nombre, m: 'Cumple 24 Semanas de gestaci√≥n (Dar Seguimiento Mensual)', i: index, tipo: 'embarazada'});
        if (semanas === 28) alertas.push({p: p.nombre, m: 'Cumple 28 Semanas de gestaci√≥n (Dar Seguimiento Mensual)', i: index, tipo: 'embarazada'});
        if (semanas === 32) alertas.push({p: p.nombre, m: 'Cumple 32 Semanas de gestaci√≥n (Dar Seguimiento para aplicaci√≥n de vacuna Virus Sincitial Respiratorio (VRS)', i: index, tipo: 'embarazada'});
        if (semanas >= 36 && semanas < 40) alertas.push({p: p.nombre, m: 'Semana ' + semanas + ' (Debe dar seguimiento Semanal hasta Finalizar Embarazo)', i: index, tipo: 'embarazada'});
        if (semanas === 40) alertas.push({p: p.nombre, m: 'Cumple 40 semanas de gestaci√≥n (Dar Seguimiento y Referir Urgente a Hospital para Evaluaci√≥n)', i: index, tipo: 'embarazada'});
    });
}

// 2. Revisar Pu√©rperas
if(typeof puerperas !== 'undefined') {
    puerperas.forEach((p, index) => {
        if(!p.fp) return;
        const fp = crearFechaLocal(p.fp);

        // Calculamos diferencia exacta en d√≠as
        const diffTime = hoyZero.getTime() - fp.getTime();
        const dias = Math.floor(diffTime / (1000 * 60 * 60 * 24));

        // Depuraci√≥n (Opcional: puedes ver esto en la consola del navegador)
        console.log(`Paciente: ${p.nombre}, D√≠as Puerperio: ${dias}`);

        if (dias === 1) alertas.push({p: p.nombre, m: 'Detecci√≥n de Pu√©rpera (Dar seguimiento para detecci√≥n luego del alta hospitalaria)', i: index, tipo: 'puerpera'});
        if (dias === 3) alertas.push({p: p.nombre, m: 'Visita de Seguimiento (3 d√≠as de puerperio) Verificar Signos de alarma de pu√©rpera y reci√©n nacido', i: index, tipo: 'puerpera'});
        if (dias === 7) alertas.push({p: p.nombre, m: 'Visita de Seguimiento (7 d√≠as de puerperio) Verificar Inscripci√≥n Infantil en Unidad de Salud y control de pu√©rpera ', i: index, tipo: 'puerpera'});
        if (dias === 15) alertas.push({p: p.nombre, m: 'visita de Seguimiento (15 d√≠as de puerperio) reforzar educaci√≥n en Lactancia Materna Exclusiva hasta los 6 meses y signos de Alarma', i: index, tipo: 'puerpera'});
        if (dias === 28) alertas.push({p: p.nombre, m: 'Visita de Seguimiento (28 d√≠as de puerperio) √öltimo seguimiento normado para Reci√©n Nacido, seguimiento a pu√©rpera', i: index, tipo: 'puerpera'});
        if (dias === 42) alertas.push({p: p.nombre, m: 'Fin de Puerperio (42 d√≠as)', i: index, tipo: 'puerpera'});
    });
}
return alertas;
}
function renderizarAlertas() {
const lista = calcularAlertas();
const contenedor = document.getElementById('contenedor-alertas');
const contador = document.getElementById('contador-alertas');

// Actualizar bot√≥n
if(contador) contador.innerText = lista.length;

// Llenar panel
if(contenedor) {
    contenedor.innerHTML = '';
    if(lista.length === 0) {
        contenedor.innerHTML = '<p style="text-align:center; color:#777;">‚úÖ No hay alertas pendientes hoy.</p>';
        return;
    }
    lista.forEach(alerta => {
        const div = document.createElement('div');
        div.className = 'alerta-card';
        // Acci√≥n para ver detalle
        const onclickJS = `mostrarSeccion('${alerta.tipo === 'embarazada' ? 'listado-embarazadas' : 'listado-puerperas'}'); mostrarDetalle(${alerta.i}, '${alerta.tipo}');`;

       // AQU√ç EST√Å EL CAMBIO DEL BOT√ìN:
            div.innerHTML = `
                <div style="flex: 1; padding-right: 10px;">
                    <h4 style="margin:0; color:#333;">${alerta.p}</h4>
                    <small style="color:#d32f2f;">${alerta.m}</small>
                </div>
                <button class="btn-alerta-blink" onclick="${onclickJS}">Ver üëÅÔ∏è</button>
            `;
            contenedor.appendChild(div);
        });
    }
}// ==========================================
// CONEXI√ìN GOOGLE SHEETS (BASE DE DATOS)
// ==========================================

const API_URL = "https://script.google.com/macros/s/AKfycbxXNjPDcnzQwbYJ3-cpwl7vNYD1lu-HMB8t_I5wImglimytkcdnsKxhyBTecE5mg1PStw/exec"; // ¬°PEGA TU URL AQU√ç!

// Funci√≥n para guardar (SUBIR) datos a la Hoja de C√°lculo
async function guardarEnNube() {
    const btn = document.getElementById('btn-nube-guardar');
    if(btn) btn.innerText = '‚è≥ Guardando...';

    const datosGlobales = {
        embarazadas: embarazadas, // Tus variables globales del script original
        puerperas: puerperas,
        archivadas: archivadas
    };

    try {
        // Usamos 'no-cors' para evitar errores, pero no podremos leer la respuesta JSON exacta
        // Sin embargo, Google Sheets procesar√° la solicitud.
        await fetch(API_URL, {
            method: 'POST',
            body: JSON.stringify(datosGlobales)
        });
        
        alert("‚úÖ Datos enviados a Google Sheets correctamente.");
        if(btn) btn.innerText = '‚òÅÔ∏è Guardar en Nube';
        
    } catch (error) {
        console.error("Error al guardar:", error);
        alert("‚ùå Error al conectar con la hoja de c√°lculo.");
        if(btn) btn.innerText = '‚òÅÔ∏è Reintentar';
    }
}

// Funci√≥n para cargar (BAJAR) datos de la Hoja de C√°lculo
async function cargarDeNube() {
    if(!confirm("‚ö†Ô∏è Esto reemplazar√° los datos actuales con los de la Hoja de C√°lculo. ¬øContinuar?")) return;
    
    const btn = document.getElementById('btn-nube-cargar');
    if(btn) btn.innerText = '‚è≥ Cargando...';

    try {
        const response = await fetch(API_URL);
        const datos = await response.json();

        // Actualizamos las variables de tu aplicaci√≥n
        if(datos.embarazadas) embarazadas = datos.embarazadas;
        if(datos.puerperas) puerperas = datos.puerperas;
        if(datos.archivadas) archivadas = datos.archivadas; // Aseg√∫rate de tener esta variable declarada arriba

        // Guardamos en localStorage para que no se pierdan al cerrar
        localStorage.setItem('embarazadas', JSON.stringify(embarazadas));
        localStorage.setItem('puerperas', JSON.stringify(puerperas));
        localStorage.setItem('archivadas', JSON.stringify(archivadas));

        // Refrescamos la pantalla (Asumiendo que tienes esta funci√≥n)
        renderizarAlertas(); 
        
        alert("‚úÖ Datos actualizados desde la nube.");
        if(btn) btn.innerText = 'üì• Bajar de Nube';

    } catch (error) {
        console.error("Error al cargar:", error);
        alert("‚ùå Error al leer la hoja de c√°lculo.");
        if(btn) btn.innerText = 'üì• Reintentar';
    }
}



</script>
</body>
</html>